<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>雙月日期選擇器 - 精準修改版</title>
    <style>
      body {
        font-family: "Microsoft JhengHei", sans-serif;
        padding: 40px;
        background: #f9f9f9;
      }
      .date-wrap {
        position: relative;
        width: 350px;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        box-sizing: border-box;
        background: #fff;
      }
      .calendar {
        position: absolute;
        top: 55px;
        left: 0;
        display: none;
        background: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 20px;
        z-index: 999;
        border-radius: 8px;
        width: 600px;
      }
      .month-container {
        display: flex;
        gap: 30px;
      }
      .month-box {
        flex: 1;
      }
      .nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-weight: bold;
      }
      .nav button {
        background: #f0f0f0;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
      }
      .nav button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }
      th {
        color: #ff625d;
        font-size: 13px;
        padding-bottom: 10px;
      }
      td {
        height: 45px;
        text-align: center;
        cursor: pointer;
        position: relative;
        font-size: 14px;
      }
      td.disabled {
        color: #ccc !important;
        cursor: default;
      }

      /* 樣式 */
      td.start-date,
      td.end-date {
        background: #ff625d !important;
        color: #fff !important;
        z-index: 2;
      }
      td.start-date {
        border-radius: 6px 0 0 6px;
      }
      td.end-date {
        border-radius: 0 6px 6px 0;
      }
      td.only-one {
        border-radius: 6px !important;
      }

      /* 區間 */
      td.in-range::before,
      td.hover-range::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 98, 93, 0.15);
        z-index: 0;
      }

      .date-box {
        position: relative;
        z-index: 3;
        display: flex;
        flex-direction: column;
      }
      .txt {
        font-size: 10px;
        height: 12px;
        margin-top: 2px;
      }
      .editing-hint {
        color: #ff625d;
        font-size: 12px;
        margin-bottom: 10px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h3>預約日期 (點選出發/抵達可個別修改)</h3>
    <div class="date-wrap">
      <input type="text" id="dateInput" readonly />
      <div class="calendar" id="calendar">
        <div id="statusHint" class="editing-hint">請選擇日期</div>
        <div class="month-container">
          <div class="month-box">
            <div class="nav">
              <button id="prevBtn">❮</button><span id="title1"></span
              ><span></span>
            </div>
            <div id="table1"></div>
          </div>
          <div class="month-box">
            <div class="nav">
              <span></span><span id="title2"></span
              ><button id="nextBtn">❯</button>
            </div>
            <div id="table2"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const input = document.getElementById("dateInput");
      const calendar = document.getElementById("calendar");
      const statusHint = document.getElementById("statusHint");
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let startDate = new Date(2026, 0, 16); // 預設 01/16
      let endDate = new Date(2026, 1, 3); // 預設 02/03
      let viewDate = new Date(2026, 0, 1); // 視圖從 1 月開始
      let mode = "idle"; // idle, edit_start, edit_end

      function render() {
        const m1 = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
        const m2 = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1);
        document.getElementById(
          "title1"
        ).textContent = `${m1.getFullYear()}年 ${m1.getMonth() + 1}月`;
        document.getElementById(
          "title2"
        ).textContent = `${m2.getFullYear()}年 ${m2.getMonth() + 1}月`;
        document.getElementById("table1").innerHTML = createTable(m1);
        document.getElementById("table2").innerHTML = createTable(m2);
        document.getElementById("prevBtn").disabled =
          m1 <= new Date(today.getFullYear(), today.getMonth(), 1);

        updateUI();
        attachEvents();
      }

      function createTable(monthDate) {
        const y = monthDate.getFullYear(),
          m = monthDate.getMonth();
        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();
        let html =
          "<table><tr><th>日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th></tr><tr>";
        for (let i = 0; i < firstDay; i++) html += "<td></td>";
        for (let d = 1; d <= lastDate; d++) {
          const curr = new Date(y, m, d);
          const dateStr = `${y}-${m + 1}-${d}`;
          html += `<td data-date="${dateStr}" class="${
            curr < today ? "disabled" : ""
          }">
                        <div class="date-box"><span>${d}</span><span class="txt"></span></div>
                    </td>`;
          if ((firstDay + d) % 7 === 0) html += "</tr><tr>";
        }
        return html + "</tr></table>";
      }

      function updateUI() {
        document.querySelectorAll("td[data-date]").forEach((td) => {
          const curr = new Date(td.dataset.date.replace(/-/g, "/"));
          const txt = td.querySelector(".txt");
          td.classList.remove(
            "start-date",
            "end-date",
            "in-range",
            "only-one",
            "hover-range"
          );
          txt.textContent = "";

          if (startDate && curr.getTime() === startDate.getTime()) {
            td.classList.add("start-date");
            txt.textContent = "出發";
            if (!endDate) td.classList.add("only-one");
          }
          if (endDate && curr.getTime() === endDate.getTime()) {
            td.classList.add("end-date");
            txt.textContent = "抵達";
            if (!startDate) td.classList.add("only-one");
          }
          if (startDate && endDate && curr > startDate && curr < endDate) {
            td.classList.add("in-range");
          }
        });

        // 更新提示文字
        if (mode === "edit_start")
          statusHint.textContent = "正在修改 [出發日期]...";
        else if (mode === "edit_end")
          statusHint.textContent = "正在修改 [抵達日期]...";
        else
          statusHint.textContent = "點擊現有日期可個別修改，或點擊新日期重選";
      }

      function attachEvents() {
        document.querySelectorAll("td[data-date]").forEach((td) => {
          if (td.classList.contains("disabled")) return;

          td.onclick = () => {
            const clicked = new Date(td.dataset.date.replace(/-/g, "/"));

            if (startDate && clicked.getTime() === startDate.getTime()) {
              // 點了出發 -> 進入修改出發模式
              mode = "edit_start";
              startDate = null;
            } else if (endDate && clicked.getTime() === endDate.getTime()) {
              // 點了抵達 -> 進入修改抵達模式
              mode = "edit_end";
              endDate = null;
            } else {
              // 點了其它日期
              if (mode === "edit_start") {
                if (endDate && clicked >= endDate) {
                  alert("出發日期必須在抵達之前");
                  return;
                }
                startDate = clicked;
                mode = "idle";
              } else if (mode === "edit_end") {
                if (startDate && clicked <= startDate) {
                  alert("抵達日期必須在出發之後");
                  return;
                }
                endDate = clicked;
                mode = "idle";
              } else {
                // 完全重選
                startDate = clicked;
                endDate = null;
                mode = "idle";
              }
            }

            updateInput();
            updateUI();
            if (startDate && endDate) {
              setTimeout(() => {
                calendar.style.display = "none";
              }, 300);
            }
          };

          // Hover 預覽邏輯
          td.onmouseenter = () => {
            if (mode === "idle" && startDate && endDate) return;
            const hoverDate = new Date(td.dataset.date.replace(/-/g, "/"));

            document.querySelectorAll("td[data-date]").forEach((t) => {
              const c = new Date(t.dataset.date.replace(/-/g, "/"));
              t.classList.remove("hover-range");

              if (
                mode === "edit_start" &&
                endDate &&
                c > hoverDate &&
                c < endDate
              )
                t.classList.add("hover-range");
              if (
                mode === "edit_end" &&
                startDate &&
                c > startDate &&
                c < hoverDate
              )
                t.classList.add("hover-range");
              if (!startDate && !endDate && c > startDate && c < hoverDate)
                t.classList.add("hover-range");
            });
          };
        });
      }

      function updateInput() {
        const fmt = (d) =>
          d
            ? `${d.getFullYear()}/${(d.getMonth() + 1)
                .toString()
                .padStart(2, "0")}/${d.getDate().toString().padStart(2, "0")}`
            : "____/__/__";
        input.value = `${fmt(startDate)} ~ ${fmt(endDate)}`;
      }

      input.onclick = (e) => {
        e.stopPropagation();
        calendar.style.display = "block";
        mode = "idle";
        render();
      };
      document.getElementById("prevBtn").onclick = (e) => {
        e.stopPropagation();
        viewDate.setMonth(viewDate.getMonth() - 1);
        render();
      };
      document.getElementById("nextBtn").onclick = (e) => {
        e.stopPropagation();
        viewDate.setMonth(viewDate.getMonth() + 1);
        render();
      };
      document.onclick = (e) => {
        if (!e.target.closest(".date-wrap")) calendar.style.display = "none";
      };

      updateInput();
    </script>
  </body>
</html>
